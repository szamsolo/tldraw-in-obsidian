diff --git a/node_modules/tldraw/dist-esm/index.d.mts b/node_modules/tldraw/dist-esm/index.d.mts
index 5a6f288..953a1b7 100644
--- a/node_modules/tldraw/dist-esm/index.d.mts
+++ b/node_modules/tldraw/dist-esm/index.d.mts
@@ -58,6 +58,7 @@ import { TLArrowShapeArrowheadStyle } from '@tldraw/editor';
 import { TLArrowShapeProps } from '@tldraw/editor';
 import { TLAsset } from '@tldraw/editor';
 import { TLAssetId } from '@tldraw/editor';
+import { TLAssetStore } from '@tldraw/editor';
 import { TLBookmarkAsset } from '@tldraw/editor';
 import { TLBookmarkShape } from '@tldraw/editor';
 import { TLBookmarkShapeProps } from '@tldraw/editor';
@@ -354,7 +355,6 @@ export declare class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
     component(shape: TLArrowShape): JSX_2.Element | null;
     indicator(shape: TLArrowShape): JSX_2.Element | null;
     onEditStart(shape: TLArrowShape): void;
-    onEditEnd(shape: TLArrowShape): void;
     toSvg(shape: TLArrowShape, ctx: SvgExportContext): JSX_2.Element;
     getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[];
     getInterpolatedProps(startShape: TLArrowShape, endShape: TLArrowShape, progress: number): TLArrowShapeProps;
@@ -2311,7 +2311,7 @@ export declare enum PORTRAIT_BREAKPOINT {
 export declare function PreferencesGroup(): JSX_2.Element;
 
 /** @public */
-export declare function preloadFont(id: string, font: TLTypeFace): Promise<FontFace>;
+export declare function preloadFont(id: string, font: TLTypeFace, targetDocument?: Document): Promise<FontFace>;
 
 /** @public @react */
 export declare function PrintItem(): JSX_2.Element;
@@ -2847,10 +2847,22 @@ export declare interface TldrawImageProps extends TLImageExportOptions {
      * The license key.
      */
     licenseKey?: string;
+    /**
+     * How should this store resolve assets?
+     */
+    assets?: TLAssetStore;
     /**
      * Asset URL overrides.
      */
     assetUrls?: TLUiAssetUrlOverrides;
+    /**
+     * The document to use in place of the global document object for the following:
+     *
+     * - preloading fonts
+     *
+     * Using this prevents bugs when using pop-out windows in Electron.
+     */
+    targetDocument?: Document;
     /**
      * Text options for the editor.
      */
diff --git a/node_modules/tldraw/dist-esm/lib/TldrawImage.mjs b/node_modules/tldraw/dist-esm/lib/TldrawImage.mjs
index 5d8ffe5..daa276f 100644
--- a/node_modules/tldraw/dist-esm/lib/TldrawImage.mjs
+++ b/node_modules/tldraw/dist-esm/lib/TldrawImage.mjs
@@ -29,7 +29,12 @@ const TldrawImage = memo(function TldrawImage2(props) {
     () => mergeArraysAndReplaceDefaults("type", _bindingUtils, defaultBindingUtils),
     [_bindingUtils]
   );
-  const store = useTLStore({ snapshot: props.snapshot, shapeUtils: shapeUtilsWithDefaults });
+  const store = useTLStore({
+    assets: props.assets,
+    snapshot: props.snapshot,
+    shapeUtils: shapeUtilsWithDefaults
+  });
+  const targetDocument = props.targetDocument ?? document;
   const {
     pageId,
     bounds,
@@ -49,7 +54,7 @@ const TldrawImage = memo(function TldrawImage2(props) {
     if (!container) return;
     if (!store) return;
     let isCancelled = false;
-    const tempElm = document.createElement("div");
+    const tempElm = targetDocument.createElement("div");
     container.appendChild(tempElm);
     container.classList.add("tl-container", "tl-theme__light");
     const editor = new Editor({
@@ -100,7 +105,8 @@ const TldrawImage = memo(function TldrawImage2(props) {
     licenseKey,
     pixelRatio,
     assetUrlsWithOverrides,
-    textOptions
+    textOptions,
+    targetDocument
   ]);
   useEffect(() => {
     return () => {
diff --git a/node_modules/tldraw/dist-esm/lib/shapes/arrow/ArrowShapeUtil.mjs b/node_modules/tldraw/dist-esm/lib/shapes/arrow/ArrowShapeUtil.mjs
index 295f3ac..305ab97 100644
--- a/node_modules/tldraw/dist-esm/lib/shapes/arrow/ArrowShapeUtil.mjs
+++ b/node_modules/tldraw/dist-esm/lib/shapes/arrow/ArrowShapeUtil.mjs
@@ -18,12 +18,14 @@ import {
   debugFlags,
   exhaustiveSwitchError,
   getDefaultColorTheme,
+  getFontsFromRichText,
   invLerp,
   lerp,
   mapObjectMapValues,
   maybeSnapToGrid,
   structuredClone,
   toDomPrecision,
+  toRichText,
   track,
   useEditor,
   useIsEditing,
@@ -32,12 +34,11 @@ import {
 } from "@tldraw/editor";
 import { useMemo } from "react";
 import { updateArrowTerminal } from "../../bindings/arrow/ArrowBindingUtil.mjs";
+import { isEmptyRichText, renderPlaintextFromRichText } from "../../utils/text/richText.mjs";
 import { PathBuilder } from "../shared/PathBuilder.mjs";
-import { PlainTextLabel } from "../shared/PlainTextLabel.mjs";
+import { RichTextLabel, RichTextSVG } from "../shared/RichTextLabel.mjs";
 import { ShapeFill } from "../shared/ShapeFill.mjs";
-import { SvgTextLabel } from "../shared/SvgTextLabel.mjs";
 import { ARROW_LABEL_PADDING, STROKE_SIZES, TEXT_PROPS } from "../shared/default-shape-constants.mjs";
-import { DefaultFontFaces } from "../shared/defaultFonts.mjs";
 import { getFillDefForCanvas, getFillDefForExport } from "../shared/defaultStyleDefs.mjs";
 import { useDefaultColorTheme } from "../shared/useDefaultColorTheme.mjs";
 import { getArrowBodyPath, getArrowHandlePath } from "./ArrowPath.mjs";
@@ -127,8 +128,12 @@ class ArrowShapeUtil extends ShapeUtil {
     return true;
   }
   getFontFaces(shape) {
-    if (!shape.props.text) return EMPTY_ARRAY;
-    return [DefaultFontFaces[`tldraw_${shape.props.font}`].normal.normal];
+    if (isEmptyRichText(shape.props.richText)) return EMPTY_ARRAY;
+    return getFontsFromRichText(this.editor, shape.props.richText, {
+      family: `tldraw_${shape.props.font}`,
+      weight: "normal",
+      style: "normal"
+    });
   }
   getDefaultProps() {
     return {
@@ -144,7 +149,7 @@ class ArrowShapeUtil extends ShapeUtil {
       end: { x: 2, y: 0 },
       arrowheadStart: "none",
       arrowheadEnd: "arrow",
-      text: "",
+      richText: toRichText(""),
       labelPosition: 0.5,
       font: "draw",
       scale: 1
@@ -165,7 +170,7 @@ class ArrowShapeUtil extends ShapeUtil {
       largeArcFlag: info.bodyArc.largeArcFlag
     }) : new Polyline2d({ points: info.route.points });
     let labelGeom;
-    if (isEditing || shape.props.text.trim()) {
+    if (isEditing || !isEmptyRichText(shape.props.richText)) {
       const labelPosition = getArrowLabelPosition(this.editor, shape);
       if (debugFlags.debugGeometry.get()) {
         debugGeom.push(...labelPosition.debugGeom);
@@ -228,7 +233,7 @@ class ArrowShapeUtil extends ShapeUtil {
     return handles;
   }
   getText(shape) {
-    return shape.props.text;
+    return renderPlaintextFromRichText(this.editor, shape.props.richText);
   }
   onHandleDrag(shape, info) {
     const handleId = info.handle.id;
@@ -584,7 +589,7 @@ class ArrowShapeUtil extends ShapeUtil {
     const labelPosition = getArrowLabelPosition(this.editor, shape);
     const isSelected = shape.id === this.editor.getOnlySelectedShapeId();
     const isEditing = this.editor.getEditingShapeId() === shape.id;
-    const showArrowLabel = isEditing || shape.props.text;
+    const showArrowLabel = isEditing || !isEmptyRichText(shape.props.richText);
     return /* @__PURE__ */ jsxs(Fragment, { children: [
       /* @__PURE__ */ jsxs(SVGContainer, { style: { minWidth: 50, minHeight: 50 }, children: [
         /* @__PURE__ */ jsx(
@@ -597,17 +602,16 @@ class ArrowShapeUtil extends ShapeUtil {
         shape.props.kind === "elbow" && debugFlags.debugElbowArrows.get() && /* @__PURE__ */ jsx(ElbowArrowDebug, { arrow: shape })
       ] }),
       showArrowLabel && /* @__PURE__ */ jsx(
-        PlainTextLabel,
+        RichTextLabel,
         {
           shapeId: shape.id,
-          classNamePrefix: "tl-arrow",
           type: "arrow",
           font: shape.props.font,
           fontSize: getArrowLabelFontSize(shape),
           lineHeight: TEXT_PROPS.lineHeight,
           align: "middle",
           verticalAlign: "middle",
-          text: shape.props.text,
+          richText: shape.props.richText,
           labelColor: theme[shape.props.labelColor].solid,
           textWidth: labelPosition.box.w - ARROW_LABEL_PADDING * 2 * shape.props.scale,
           isSelected,
@@ -627,7 +631,8 @@ class ArrowShapeUtil extends ShapeUtil {
     const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, info?.bindings);
     const geometry = this.editor.getShapeGeometry(shape);
     const bounds = geometry.bounds;
-    const labelGeometry = isEditing || shape.props.text.trim() ? geometry.children[1] : null;
+    const isEmpty = isEmptyRichText(shape.props.richText);
+    const labelGeometry = isEditing || !isEmpty ? geometry.children[1] : null;
     if (Vec.Equals(start, end)) return null;
     const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale;
     const as = info.start.arrowhead && getArrowheadPathForType(info, "start", strokeWidth);
@@ -654,7 +659,7 @@ class ArrowShapeUtil extends ShapeUtil {
         ArrowClipPath,
         {
           radius: 3.5 * shape.props.scale,
-          hasText: shape.props.text.trim().length > 0,
+          hasText: !isEmpty,
           bounds,
           labelBounds,
           as: clipStartArrowhead && as ? as : "",
@@ -711,7 +716,7 @@ class ArrowShapeUtil extends ShapeUtil {
     ] });
   }
   onEditStart(shape) {
-    if (shape.props.text.trim() === "") {
+    if (isEmptyRichText(shape.props.richText)) {
       const labelPosition = getArrowLabelDefaultPosition(this.editor, shape);
       this.editor.updateShape({
         id: shape.id,
@@ -720,24 +725,6 @@ class ArrowShapeUtil extends ShapeUtil {
       });
     }
   }
-  onEditEnd(shape) {
-    const {
-      id,
-      type,
-      props: { text }
-    } = shape;
-    if (text.trimEnd() !== shape.props.text) {
-      this.editor.updateShapes([
-        {
-          id,
-          type,
-          props: {
-            text: text.trimEnd()
-          }
-        }
-      ]);
-    }
-  }
   toSvg(shape, ctx) {
     ctx.addExportDef(getFillDefForExport(shape.props.fill));
     const theme = getDefaultColorTheme(ctx);
@@ -745,13 +732,13 @@ class ArrowShapeUtil extends ShapeUtil {
     return /* @__PURE__ */ jsxs("g", { transform: `scale(${scaleFactor})`, children: [
       /* @__PURE__ */ jsx(ArrowSvg, { shape, shouldDisplayHandles: false }),
       /* @__PURE__ */ jsx(
-        SvgTextLabel,
+        RichTextSVG,
         {
           fontSize: getArrowLabelFontSize(shape),
           font: shape.props.font,
           align: "middle",
           verticalAlign: "middle",
-          text: shape.props.text,
+          richText: shape.props.richText,
           labelColor: theme[shape.props.labelColor].solid,
           bounds: getArrowLabelPosition(this.editor, shape).box.clone().expandBy(-ARROW_LABEL_PADDING * shape.props.scale),
           padding: 0,
@@ -816,6 +803,7 @@ const ArrowSvg = track(function ArrowSvg2({
   if (!geometry) return null;
   const bounds = Box.ZeroFix(geometry.bounds);
   const bindings = getArrowBindings(editor, shape);
+  const isEmpty = isEmptyRichText(shape.props.richText);
   if (!info?.isValid) return null;
   const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale;
   const as = info.start.arrowhead && getArrowheadPathForType(info, "start", strokeWidth);
@@ -844,7 +832,7 @@ const ArrowSvg = track(function ArrowSvg2({
       ArrowClipPath,
       {
         radius: 3.5 * shape.props.scale,
-        hasText: isEditing || shape.props.text.trim().length > 0,
+        hasText: isEditing || !isEmpty,
         bounds,
         labelBounds: labelPosition.box,
         as: clipStartArrowhead && as ? as : "",
diff --git a/node_modules/tldraw/dist-esm/lib/shapes/arrow/arrowLabel.mjs b/node_modules/tldraw/dist-esm/lib/shapes/arrow/arrowLabel.mjs
index aa47dd1..0f2e312 100644
--- a/node_modules/tldraw/dist-esm/lib/shapes/arrow/arrowLabel.mjs
+++ b/node_modules/tldraw/dist-esm/lib/shapes/arrow/arrowLabel.mjs
@@ -10,8 +10,11 @@ import {
   clamp,
   createComputedCache,
   exhaustiveSwitchError,
-  getChangedKeys
+  getChangedKeys,
+  pointInPolygon,
+  toRichText
 } from "@tldraw/editor";
+import { isEmptyRichText, renderHtmlFromRichTextForMeasurement } from "../../utils/text/richText.mjs";
 import {
   ARROW_LABEL_FONT_SIZES,
   ARROW_LABEL_PADDING,
@@ -50,10 +53,14 @@ const labelSizeCache = createComputedCache(
     let width = 0;
     let height = 0;
     const bodyGeom = getArrowBodyGeometry(editor, shape);
-    const text = shape.props.text || "i";
+    const isEmpty = isEmptyRichText(shape.props.richText);
+    const html = renderHtmlFromRichTextForMeasurement(
+      editor,
+      isEmpty ? toRichText("i") : shape.props.richText
+    );
     const bodyBounds = bodyGeom.bounds;
     const fontSize = getArrowLabelFontSize(shape);
-    const { w, h } = editor.textMeasure.measureText(text, {
+    const { w, h } = editor.textMeasure.measureHtml(html, {
       ...TEXT_PROPS,
       fontFamily: FONT_FAMILIES[shape.props.font],
       fontSize,
@@ -73,7 +80,7 @@ const labelSizeCache = createComputedCache(
       shouldSquish = true;
     }
     if (shouldSquish) {
-      const { w: squishedWidth, h: squishedHeight } = editor.textMeasure.measureText(text, {
+      const { w: squishedWidth, h: squishedHeight } = editor.textMeasure.measureHtml(html, {
         ...TEXT_PROPS,
         fontFamily: FONT_FAMILIES[shape.props.font],
         fontSize,
@@ -216,10 +223,17 @@ function getArrowLabelDefaultPosition(editor, shape) {
       exhaustiveSwitchError(info, "type");
   }
 }
+function isOverArrowLabel(editor, shape) {
+  if (!editor.isShapeOfType(shape, "arrow")) return false;
+  const pointInShapeSpace = editor.getPointInShapeSpace(shape, editor.inputs.currentPagePoint);
+  const labelGeometry = editor.getShapeGeometry(shape).children[1];
+  return labelGeometry && pointInPolygon(pointInShapeSpace, labelGeometry.vertices);
+}
 export {
   getArrowBodyGeometry,
   getArrowLabelDefaultPosition,
   getArrowLabelFontSize,
-  getArrowLabelPosition
+  getArrowLabelPosition,
+  isOverArrowLabel
 };
 //# sourceMappingURL=arrowLabel.mjs.map
diff --git a/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/Idle.mjs b/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/Idle.mjs
index 8bf7381..84526d5 100644
--- a/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/Idle.mjs
+++ b/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/Idle.mjs
@@ -7,6 +7,7 @@ import {
   pointInPolygon,
   toRichText
 } from "@tldraw/editor";
+import { isOverArrowLabel } from "../../../shapes/arrow/arrowLabel.mjs";
 import { getHitShapeOnCanvasPointerDown } from "../../selection-logic/getHitShapeOnCanvasPointerDown.mjs";
 import { getShouldEnterCropMode } from "../../selection-logic/getShouldEnterCropModeOnPointerDown.mjs";
 import { selectOnCanvasPointerUp } from "../../selection-logic/selectOnCanvasPointerUp.mjs";
@@ -69,10 +70,6 @@ class Idle extends StateNode {
       }
       case "shape": {
         const { shape } = info;
-        if (this.isOverArrowLabelTest(shape)) {
-          this.parent.transition("pointing_arrow_label", info);
-          break;
-        }
         if (this.editor.isShapeOrAncestorLocked(shape)) {
           this.parent.transition("pointing_canvas", info);
           break;
@@ -452,17 +449,7 @@ class Idle extends StateNode {
   }
   isOverArrowLabelTest(shape) {
     if (!shape) return false;
-    if (this.editor.isShapeOfType(shape, "arrow")) {
-      const pointInShapeSpace = this.editor.getPointInShapeSpace(
-        shape,
-        this.editor.inputs.currentPagePoint
-      );
-      const labelGeometry = this.editor.getShapeGeometry(shape).children[1];
-      if (labelGeometry && pointInPolygon(pointInShapeSpace, labelGeometry.vertices)) {
-        return true;
-      }
-    }
-    return false;
+    return isOverArrowLabel(this.editor, shape);
   }
   handleDoubleClickOnCanvas(info) {
     if (this.editor.getIsReadonly()) return;
diff --git a/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/PointingShape.mjs b/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/PointingShape.mjs
index ddf7f67..f1c1763 100644
--- a/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/PointingShape.mjs
+++ b/node_modules/tldraw/dist-esm/lib/tools/SelectTool/childStates/PointingShape.mjs
@@ -1,4 +1,5 @@
 import { StateNode } from "@tldraw/editor";
+import { isOverArrowLabel } from "../../../shapes/arrow/arrowLabel.mjs";
 import { getTextLabels } from "../../../utils/shapes/shapes.mjs";
 class PointingShape extends StateNode {
   static id = "pointing_shape";
@@ -154,6 +155,10 @@ class PointingShape extends StateNode {
   }
   onPointerMove(info) {
     if (this.editor.inputs.isDragging) {
+      if (isOverArrowLabel(this.editor, this.hitShape)) {
+        this.parent.transition("pointing_arrow_label", { ...info, shape: this.hitShape });
+        return;
+      }
       if (this.didCtrlOnEnter) {
         this.parent.transition("brushing", info);
       } else {
diff --git a/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/DefaultRichTextToolbar.mjs b/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/DefaultRichTextToolbar.mjs
index 7d16369..73a5b18 100644
--- a/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/DefaultRichTextToolbar.mjs
+++ b/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/DefaultRichTextToolbar.mjs
@@ -127,6 +127,7 @@ function useIsMousingDownOnTextEditor(textEditor) {
     touchDownEvents.forEach((eventName) => {
       textEditor.view.dom.addEventListener(eventName, handlePointingDown);
     });
+    const document = textEditor.view.dom.ownerDocument;
     touchUpEvents.forEach((eventName) => {
       document.body.addEventListener(eventName, handlePointingUp);
     });
diff --git a/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/OverflowingToolbar.mjs b/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/OverflowingToolbar.mjs
index ebb04d6..9535412 100644
--- a/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/OverflowingToolbar.mjs
+++ b/node_modules/tldraw/dist-esm/lib/ui/components/Toolbar/OverflowingToolbar.mjs
@@ -78,7 +78,7 @@ function OverflowingToolbar({ children }) {
     }
     rButtons.current = Array.from(mainToolsRef.current?.children ?? []).filter(
       (el) => {
-        if (!(el instanceof HTMLElement)) return false;
+        if (!el.instanceOf(HTMLElement)) return false;
         if (el.tagName.toLowerCase() !== "button") return false;
         return !!(el.offsetWidth || el.offsetHeight);
       }
@@ -114,9 +114,9 @@ function OverflowingToolbar({ children }) {
         rButtons.current[index]?.click();
       }
     }
-    document.addEventListener("keydown", handleKeyDown);
+    editor.getContainer().ownerDocument.addEventListener("keydown", handleKeyDown);
     return () => {
-      document.removeEventListener("keydown", handleKeyDown);
+      editor.getContainer().ownerDocument.removeEventListener("keydown", handleKeyDown);
     };
   }, [editor]);
   const popoverId = "toolbar overflow";
diff --git a/node_modules/tldraw/dist-esm/lib/ui/components/primitives/TldrawUiButtonPicker.mjs b/node_modules/tldraw/dist-esm/lib/ui/components/primitives/TldrawUiButtonPicker.mjs
index dadc2d7..cc16e9e 100644
--- a/node_modules/tldraw/dist-esm/lib/ui/components/primitives/TldrawUiButtonPicker.mjs
+++ b/node_modules/tldraw/dist-esm/lib/ui/components/primitives/TldrawUiButtonPicker.mjs
@@ -1,6 +1,7 @@
 import { jsx } from "react/jsx-runtime";
 import {
   DefaultColorStyle,
+  useContainer,
   useEditor
 } from "@tldraw/editor";
 import classNames from "classnames";
@@ -22,6 +23,7 @@ const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker2(props) {
     onHistoryMark,
     theme
   } = props;
+  const container = useContainer();
   const editor = useEditor();
   const msg = useTranslation();
   const breakpoint = useBreakpoint();
@@ -35,7 +37,7 @@ const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker2(props) {
   } = useMemo(() => {
     const handlePointerUp = () => {
       rPointing.current = false;
-      window.removeEventListener("pointerup", handlePointerUp);
+      container.win.removeEventListener("pointerup", handlePointerUp);
       const origActiveEl = rPointingOriginalActiveElement.current;
       if (origActiveEl && (["TEXTAREA", "INPUT"].includes(origActiveEl.nodeName) || origActiveEl.isContentEditable)) {
         origActiveEl.focus();
@@ -55,8 +57,8 @@ const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker2(props) {
       onHistoryMark?.("point picker item");
       onValueChange(style, id);
       rPointing.current = true;
-      rPointingOriginalActiveElement.current = document.activeElement;
-      window.addEventListener("pointerup", handlePointerUp);
+      rPointingOriginalActiveElement.current = container.ownerDocument.activeElement;
+      container.win.addEventListener("pointerup", handlePointerUp);
     };
     const handleButtonPointerEnter2 = (e) => {
       if (!rPointing.current) return;
@@ -74,7 +76,7 @@ const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker2(props) {
       handleButtonPointerEnter: handleButtonPointerEnter2,
       handleButtonPointerUp: handleButtonPointerUp2
     };
-  }, [editor, breakpoint, value, onHistoryMark, onValueChange, style]);
+  }, [editor, breakpoint, value, onHistoryMark, onValueChange, style, container]);
   return /* @__PURE__ */ jsx(
     TldrawUiToolbarToggleGroup,
     {
diff --git a/node_modules/tldraw/dist-esm/lib/ui/hooks/useClipboardEvents.mjs b/node_modules/tldraw/dist-esm/lib/ui/hooks/useClipboardEvents.mjs
index 3424258..224cf1d 100644
--- a/node_modules/tldraw/dist-esm/lib/ui/hooks/useClipboardEvents.mjs
+++ b/node_modules/tldraw/dist-esm/lib/ui/hooks/useClipboardEvents.mjs
@@ -55,7 +55,7 @@ const isSvgText = (text) => {
 };
 const INPUTS = ["input", "select", "textarea"];
 function areShortcutsDisabled(editor) {
-  const { activeElement } = document;
+  const { activeElement } = editor.getContainer().ownerDocument;
   return editor.menus.hasAnyOpenMenus() || activeElement && (activeElement.isContentEditable || INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1);
 }
 const handleText = (editor, data, point, sources) => {
@@ -439,7 +439,7 @@ function useMenuClipboardEvents() {
     async function onPaste(data, source, point) {
       if (!editor) return;
       if (editor.getEditingShapeId() !== null) return;
-      if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
+      if (Array.isArray(data) && data[0] instanceof editor.getContainer().win.window.ClipboardItem) {
         handlePasteFromClipboardApi({ editor, clipboardItems: data, point });
         trackEvent("paste", { source: "menu" });
       } else {
@@ -490,6 +490,7 @@ function useNativeClipboardEvents() {
         });
       }
     };
+    const container = editor.getContainer();
     const paste = (e) => {
       if (disablingMiddleClickPaste) {
         stopEventPropagation(e);
@@ -510,7 +511,7 @@ function useNativeClipboardEvents() {
         const fallbackFiles = Array.from(e.clipboardData?.files || []);
         navigator.clipboard.read().then(
           (clipboardItems) => {
-            if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
+            if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof container.win.window.ClipboardItem) {
               handlePasteFromClipboardApi({ editor, clipboardItems, point, fallbackFiles });
             }
           },
@@ -524,15 +525,15 @@ function useNativeClipboardEvents() {
       preventDefault(e);
       trackEvent("paste", { source: "kbd" });
     };
-    document.addEventListener("copy", copy);
-    document.addEventListener("cut", cut);
-    document.addEventListener("paste", paste);
-    document.addEventListener("pointerup", pointerUpHandler);
+    container.ownerDocument.addEventListener("copy", copy);
+    container.ownerDocument.addEventListener("cut", cut);
+    container.ownerDocument.addEventListener("paste", paste);
+    container.ownerDocument.addEventListener("pointerup", pointerUpHandler);
     return () => {
-      document.removeEventListener("copy", copy);
-      document.removeEventListener("cut", cut);
-      document.removeEventListener("paste", paste);
-      document.removeEventListener("pointerup", pointerUpHandler);
+      container.ownerDocument.removeEventListener("copy", copy);
+      container.ownerDocument.removeEventListener("cut", cut);
+      container.ownerDocument.removeEventListener("paste", paste);
+      container.ownerDocument.removeEventListener("pointerup", pointerUpHandler);
     };
   }, [editor, trackEvent, appIsFocused]);
 }
diff --git a/node_modules/tldraw/dist-esm/lib/ui/hooks/useKeyboardShortcuts.mjs b/node_modules/tldraw/dist-esm/lib/ui/hooks/useKeyboardShortcuts.mjs
index ce5b32d..5fe9f60 100644
--- a/node_modules/tldraw/dist-esm/lib/ui/hooks/useKeyboardShortcuts.mjs
+++ b/node_modules/tldraw/dist-esm/lib/ui/hooks/useKeyboardShortcuts.mjs
@@ -1,6 +1,7 @@
 import {
   isAccelKey,
   preventDefault,
+  useContainer,
   useEditor,
   useValue
 } from "@tldraw/editor";
@@ -18,6 +19,7 @@ const SKIP_KBDS = [
   "asset"
 ];
 function useKeyboardShortcuts() {
+  const container = useContainer();
   const editor = useEditor();
   const isReadonlyMode = useReadonly();
   const actions = useActions();
@@ -26,9 +28,9 @@ function useKeyboardShortcuts() {
   useEffect(() => {
     if (!isFocused) return;
     const disposables = new Array();
-    const container = editor.getContainer();
+    const container2 = editor.getContainer();
     const hot = (keys, callback) => {
-      hotkeys(keys, { element: container.ownerDocument.body }, callback);
+      hotkeys(keys, { element: container2.ownerDocument.body }, callback);
       disposables.push(() => {
         hotkeys.unbind(keys, callback);
       });
@@ -36,7 +38,7 @@ function useKeyboardShortcuts() {
     const hotUp = (keys, callback) => {
       hotkeys(
         keys,
-        { element: container.ownerDocument.body, keyup: true, keydown: false },
+        { element: container2.ownerDocument.body, keyup: true, keydown: false },
         callback
       );
       disposables.push(() => {
@@ -112,7 +114,7 @@ function useKeyboardShortcuts() {
     return () => {
       disposables.forEach((d) => d());
     };
-  }, [actions, tools, isReadonlyMode, editor, isFocused]);
+  }, [actions, tools, isReadonlyMode, editor, container, isFocused]);
 }
 function areShortcutsDisabled(editor) {
   return editor.menus.hasAnyOpenMenus() || editor.getEditingShapeId() !== null || editor.getCrashingError() || !editor.user.getAreKeyboardShortcutsEnabled();
diff --git a/node_modules/tldraw/dist-esm/lib/utils/assets/preload-font.mjs b/node_modules/tldraw/dist-esm/lib/utils/assets/preload-font.mjs
index 6ba966f..2a6ff39 100644
--- a/node_modules/tldraw/dist-esm/lib/utils/assets/preload-font.mjs
+++ b/node_modules/tldraw/dist-esm/lib/utils/assets/preload-font.mjs
@@ -1,4 +1,4 @@
-async function preloadFont(id, font) {
+async function preloadFont(id, font, targetDocument) {
   const {
     url,
     style = "normal",
@@ -22,7 +22,7 @@ async function preloadFont(id, font) {
   };
   const fontInstance = new FontFace(id, `url(${url})`, descriptors);
   await fontInstance.load();
-  document.fonts.add(fontInstance);
+  (targetDocument ?? document).fonts.add(fontInstance);
   fontInstance.$$_url = url;
   fontInstance.$$_fontface = `
 @font-face {
diff --git a/node_modules/tldraw/dist-esm/lib/utils/excalidraw/putExcalidrawContent.mjs b/node_modules/tldraw/dist-esm/lib/utils/excalidraw/putExcalidrawContent.mjs
index f644353..f48a5dd 100644
--- a/node_modules/tldraw/dist-esm/lib/utils/excalidraw/putExcalidrawContent.mjs
+++ b/node_modules/tldraw/dist-esm/lib/utils/excalidraw/putExcalidrawContent.mjs
@@ -170,7 +170,7 @@ async function putExcalidrawContent(editor, excalidrawClipboardContent, point) {
           ...base,
           type: "arrow",
           props: {
-            text,
+            richText: toRichText(text),
             kind: element.elbowed ? "elbow" : "arc",
             bend: getBend(element, start, end),
             dash: getDash(element),
diff --git a/node_modules/tldraw/dist-esm/lib/utils/export/export.mjs b/node_modules/tldraw/dist-esm/lib/utils/export/export.mjs
index 808cf20..33325ad 100644
--- a/node_modules/tldraw/dist-esm/lib/utils/export/export.mjs
+++ b/node_modules/tldraw/dist-esm/lib/utils/export/export.mjs
@@ -46,7 +46,7 @@ const clipboardMimeTypesByFormat = {
   jpeg: "image/jpeg",
   png: "image/png",
   webp: "image/webp",
-  svg: "text/plain"
+  svg: "image/svg+xml"
 };
 function exportToImagePromiseForClipboard(editor, ids, opts = {}) {
   const idsToUse = ids?.length ? ids : [...editor.getCurrentPageShapeIds()];
diff --git a/node_modules/tldraw/dist-esm/lib/utils/tldr/buildFromV1Document.mjs b/node_modules/tldraw/dist-esm/lib/utils/tldr/buildFromV1Document.mjs
index 9bec14f..8c67d25 100644
--- a/node_modules/tldraw/dist-esm/lib/utils/tldr/buildFromV1Document.mjs
+++ b/node_modules/tldraw/dist-esm/lib/utils/tldr/buildFromV1Document.mjs
@@ -325,7 +325,7 @@ function buildFromV1Document(editor, _document) {
                 ...inCommon,
                 type: "arrow",
                 props: {
-                  text: v1Shape.label ?? "",
+                  richText: toRichText(v1Shape.label ?? ""),
                   color: getV2Color(v1Shape.style.color),
                   labelColor: getV2Color(v1Shape.style.color),
                   size: getV2Size(v1Shape.style.size),
diff --git a/node_modules/tldraw/src/lib/TldrawImage.tsx b/node_modules/tldraw/src/lib/TldrawImage.tsx
index 37fe0e3..628eefe 100644
--- a/node_modules/tldraw/src/lib/TldrawImage.tsx
+++ b/node_modules/tldraw/src/lib/TldrawImage.tsx
@@ -2,6 +2,7 @@ import {
 	Editor,
 	TLAnyBindingUtilConstructor,
 	TLAnyShapeUtilConstructor,
+	TLAssetStore,
 	TLEditorSnapshot,
 	TLImageExportOptions,
 	TLPageId,
@@ -47,10 +48,22 @@ export interface TldrawImageProps extends TLImageExportOptions {
 	 * The license key.
 	 */
 	licenseKey?: string
+	/**
+	 * How should this store resolve assets?
+	 */
+	assets?: TLAssetStore
 	/**
 	 * Asset URL overrides.
 	 */
 	assetUrls?: TLUiAssetUrlOverrides
+	/**
+	 * The document to use in place of the global document object for the following:
+	 *
+	 * - preloading fonts
+	 *
+	 * Using this prevents bugs when using pop-out windows in Electron.
+	 */
+	targetDocument?: Document
 	/**
 	 * Text options for the editor.
 	 */
@@ -96,7 +109,13 @@ export const TldrawImage = memo(function TldrawImage(props: TldrawImageProps) {
 		() => mergeArraysAndReplaceDefaults('type', _bindingUtils, defaultBindingUtils),
 		[_bindingUtils]
 	)
-	const store = useTLStore({ snapshot: props.snapshot, shapeUtils: shapeUtilsWithDefaults })
+	const store = useTLStore({
+		assets: props.assets,
+		snapshot: props.snapshot,
+		shapeUtils: shapeUtilsWithDefaults,
+	})
+
+	const targetDocument = props.targetDocument ?? document
 
 	const {
 		pageId,
@@ -120,7 +139,7 @@ export const TldrawImage = memo(function TldrawImage(props: TldrawImageProps) {
 
 		let isCancelled = false
 
-		const tempElm = document.createElement('div')
+		const tempElm = targetDocument.createElement('div')
 		container.appendChild(tempElm)
 		container.classList.add('tl-container', 'tl-theme__light')
 
@@ -181,6 +200,7 @@ export const TldrawImage = memo(function TldrawImage(props: TldrawImageProps) {
 		pixelRatio,
 		assetUrlsWithOverrides,
 		textOptions,
+		targetDocument,
 	])
 
 	useEffect(() => {
diff --git a/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.test.ts b/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.test.ts
index f5a6c7d..ae36806 100644
--- a/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.test.ts
+++ b/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.test.ts
@@ -1,4 +1,4 @@
-import { HALF_PI, TLArrowShape, TLShapeId, createShapeId } from '@tldraw/editor'
+import { HALF_PI, TLArrowShape, TLShapeId, createShapeId, toRichText } from '@tldraw/editor'
 import { TestEditor } from '../../../test/TestEditor'
 import { createOrUpdateArrowBinding, getArrowBindings } from './shared'
 
@@ -333,7 +333,7 @@ describe('Arrow labels', () => {
 		editor.setCurrentTool('arrow').pointerDown(10, 10).pointerMove(100, 100).pointerUp()
 		const arrowId = editor.getOnlySelectedShape()!.id
 		editor.updateShapes<TLArrowShape>([
-			{ id: arrowId, type: 'arrow', props: { text: 'Test Label' } },
+			{ id: arrowId, type: 'arrow', props: { richText: toRichText('Test Label') } },
 		])
 	})
 
@@ -341,7 +341,7 @@ describe('Arrow labels', () => {
 		const arrowId = editor.getOnlySelectedShape()!.id
 		expect(arrow(arrowId)).toMatchObject({
 			props: {
-				text: 'Test Label',
+				richText: toRichText('Test Label'),
 			},
 		})
 	})
@@ -349,11 +349,11 @@ describe('Arrow labels', () => {
 	it('should update the label of an arrow', () => {
 		const arrowId = editor.getOnlySelectedShape()!.id
 		editor.updateShapes<TLArrowShape>([
-			{ id: arrowId, type: 'arrow', props: { text: 'New Label' } },
+			{ id: arrowId, type: 'arrow', props: { richText: toRichText('New Label') } },
 		])
 		expect(arrow(arrowId)).toMatchObject({
 			props: {
-				text: 'New Label',
+				richText: toRichText('New Label'),
 			},
 		})
 	})
diff --git a/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx b/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx
index edb7a20..f08bf31 100644
--- a/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx
+++ b/node_modules/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx
@@ -32,12 +32,14 @@ import {
 	debugFlags,
 	exhaustiveSwitchError,
 	getDefaultColorTheme,
+	getFontsFromRichText,
 	invLerp,
 	lerp,
 	mapObjectMapValues,
 	maybeSnapToGrid,
 	structuredClone,
 	toDomPrecision,
+	toRichText,
 	track,
 	useEditor,
 	useIsEditing,
@@ -46,12 +48,11 @@ import {
 } from '@tldraw/editor'
 import React, { useMemo } from 'react'
 import { updateArrowTerminal } from '../../bindings/arrow/ArrowBindingUtil'
+import { isEmptyRichText, renderPlaintextFromRichText } from '../../utils/text/richText'
 import { PathBuilder } from '../shared/PathBuilder'
-import { PlainTextLabel } from '../shared/PlainTextLabel'
+import { RichTextLabel, RichTextSVG } from '../shared/RichTextLabel'
 import { ShapeFill } from '../shared/ShapeFill'
-import { SvgTextLabel } from '../shared/SvgTextLabel'
 import { ARROW_LABEL_PADDING, STROKE_SIZES, TEXT_PROPS } from '../shared/default-shape-constants'
-import { DefaultFontFaces } from '../shared/defaultFonts'
 import { getFillDefForCanvas, getFillDefForExport } from '../shared/defaultStyleDefs'
 import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'
 import { getArrowBodyPath, getArrowHandlePath } from './ArrowPath'
@@ -156,8 +157,13 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 	}
 
 	override getFontFaces(shape: TLArrowShape) {
-		if (!shape.props.text) return EMPTY_ARRAY
-		return [DefaultFontFaces[`tldraw_${shape.props.font}`].normal.normal]
+		if (isEmptyRichText(shape.props.richText)) return EMPTY_ARRAY
+
+		return getFontsFromRichText(this.editor, shape.props.richText, {
+			family: `tldraw_${shape.props.font}`,
+			weight: 'normal',
+			style: 'normal',
+		})
 	}
 
 	override getDefaultProps(): TLArrowShape['props'] {
@@ -174,7 +180,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 			end: { x: 2, y: 0 },
 			arrowheadStart: 'none',
 			arrowheadEnd: 'arrow',
-			text: '',
+			richText: toRichText(''),
 			labelPosition: 0.5,
 			font: 'draw',
 			scale: 1,
@@ -204,7 +210,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 					: new Polyline2d({ points: info.route.points })
 
 		let labelGeom
-		if (isEditing || shape.props.text.trim()) {
+		if (isEditing || !isEmptyRichText(shape.props.richText)) {
 			const labelPosition = getArrowLabelPosition(this.editor, shape)
 			if (debugFlags.debugGeometry.get()) {
 				debugGeom.push(...labelPosition.debugGeom)
@@ -276,7 +282,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 	}
 
 	override getText(shape: TLArrowShape) {
-		return shape.props.text
+		return renderPlaintextFromRichText(this.editor, shape.props.richText)
 	}
 
 	override onHandleDrag(shape: TLArrowShape, info: TLHandleDragInfo<TLArrowShape>) {
@@ -757,7 +763,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 		const labelPosition = getArrowLabelPosition(this.editor, shape)
 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()
 		const isEditing = this.editor.getEditingShapeId() === shape.id
-		const showArrowLabel = isEditing || shape.props.text
+		const showArrowLabel = isEditing || !isEmptyRichText(shape.props.richText)
 
 		return (
 			<>
@@ -771,16 +777,15 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 					)}
 				</SVGContainer>
 				{showArrowLabel && (
-					<PlainTextLabel
+					<RichTextLabel
 						shapeId={shape.id}
-						classNamePrefix="tl-arrow"
 						type="arrow"
 						font={shape.props.font}
 						fontSize={getArrowLabelFontSize(shape)}
 						lineHeight={TEXT_PROPS.lineHeight}
 						align="middle"
 						verticalAlign="middle"
-						text={shape.props.text}
+						richText={shape.props.richText}
 						labelColor={theme[shape.props.labelColor].solid}
 						textWidth={labelPosition.box.w - ARROW_LABEL_PADDING * 2 * shape.props.scale}
 						isSelected={isSelected}
@@ -806,9 +811,9 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 		const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, info?.bindings)
 		const geometry = this.editor.getShapeGeometry<Group2d>(shape)
 		const bounds = geometry.bounds
+		const isEmpty = isEmptyRichText(shape.props.richText)
 
-		const labelGeometry =
-			isEditing || shape.props.text.trim() ? (geometry.children[1] as Rectangle2d) : null
+		const labelGeometry = isEditing || !isEmpty ? (geometry.children[1] as Rectangle2d) : null
 
 		if (Vec.Equals(start, end)) return null
 
@@ -847,7 +852,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 					<defs>
 						<ArrowClipPath
 							radius={3.5 * shape.props.scale}
-							hasText={shape.props.text.trim().length > 0}
+							hasText={!isEmpty}
 							bounds={bounds}
 							labelBounds={labelBounds}
 							as={clipStartArrowhead && as ? as : ''}
@@ -905,7 +910,7 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 	}
 
 	override onEditStart(shape: TLArrowShape) {
-		if (shape.props.text.trim() === '') {
+		if (isEmptyRichText(shape.props.richText)) {
 			// editing text for the first time, so set the position to the default:
 			const labelPosition = getArrowLabelDefaultPosition(this.editor, shape)
 			this.editor.updateShape<TLArrowShape>({
@@ -916,26 +921,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 		}
 	}
 
-	override onEditEnd(shape: TLArrowShape) {
-		const {
-			id,
-			type,
-			props: { text },
-		} = shape
-
-		if (text.trimEnd() !== shape.props.text) {
-			this.editor.updateShapes<TLArrowShape>([
-				{
-					id,
-					type,
-					props: {
-						text: text.trimEnd(),
-					},
-				},
-			])
-		}
-	}
-
 	override toSvg(shape: TLArrowShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFillDefForExport(shape.props.fill))
 		const theme = getDefaultColorTheme(ctx)
@@ -944,12 +929,12 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {
 		return (
 			<g transform={`scale(${scaleFactor})`}>
 				<ArrowSvg shape={shape} shouldDisplayHandles={false} />
-				<SvgTextLabel
+				<RichTextSVG
 					fontSize={getArrowLabelFontSize(shape)}
 					font={shape.props.font}
 					align="middle"
 					verticalAlign="middle"
-					text={shape.props.text}
+					richText={shape.props.richText}
 					labelColor={theme[shape.props.labelColor].solid}
 					bounds={getArrowLabelPosition(this.editor, shape)
 						.box.clone()
@@ -1031,6 +1016,7 @@ const ArrowSvg = track(function ArrowSvg({
 	if (!geometry) return null
 	const bounds = Box.ZeroFix(geometry.bounds)
 	const bindings = getArrowBindings(editor, shape)
+	const isEmpty = isEmptyRichText(shape.props.richText)
 
 	if (!info?.isValid) return null
 
@@ -1081,7 +1067,7 @@ const ArrowSvg = track(function ArrowSvg({
 				<clipPath id={clipPathId}>
 					<ArrowClipPath
 						radius={3.5 * shape.props.scale}
-						hasText={isEditing || shape.props.text.trim().length > 0}
+						hasText={isEditing || !isEmpty}
 						bounds={bounds}
 						labelBounds={labelPosition.box}
 						as={clipStartArrowhead && as ? as : ''}
diff --git a/node_modules/tldraw/src/lib/shapes/arrow/arrowLabel.ts b/node_modules/tldraw/src/lib/shapes/arrow/arrowLabel.ts
index 45b9f83..b59826a 100644
--- a/node_modules/tldraw/src/lib/shapes/arrow/arrowLabel.ts
+++ b/node_modules/tldraw/src/lib/shapes/arrow/arrowLabel.ts
@@ -9,13 +9,17 @@ import {
 	Polygon2d,
 	Polyline2d,
 	TLArrowShape,
+	TLShape,
 	Vec,
 	VecLike,
 	clamp,
 	createComputedCache,
 	exhaustiveSwitchError,
 	getChangedKeys,
+	pointInPolygon,
+	toRichText,
 } from '@tldraw/editor'
+import { isEmptyRichText, renderHtmlFromRichTextForMeasurement } from '../../utils/text/richText'
 import {
 	ARROW_LABEL_FONT_SIZES,
 	ARROW_LABEL_PADDING,
@@ -59,14 +63,18 @@ const labelSizeCache = createComputedCache(
 
 		const bodyGeom = getArrowBodyGeometry(editor, shape)
 		// We use 'i' as a default label to measure against as a minimum width.
-		const text = shape.props.text || 'i'
+		const isEmpty = isEmptyRichText(shape.props.richText)
+		const html = renderHtmlFromRichTextForMeasurement(
+			editor,
+			isEmpty ? toRichText('i') : shape.props.richText
+		)
 
 		const bodyBounds = bodyGeom.bounds
 
 		const fontSize = getArrowLabelFontSize(shape)
 
 		// First we measure the text with no constraints
-		const { w, h } = editor.textMeasure.measureText(text, {
+		const { w, h } = editor.textMeasure.measureHtml(html, {
 			...TEXT_PROPS,
 			fontFamily: FONT_FAMILIES[shape.props.font],
 			fontSize,
@@ -96,7 +104,7 @@ const labelSizeCache = createComputedCache(
 		}
 
 		if (shouldSquish) {
-			const { w: squishedWidth, h: squishedHeight } = editor.textMeasure.measureText(text, {
+			const { w: squishedWidth, h: squishedHeight } = editor.textMeasure.measureHtml(html, {
 				...TEXT_PROPS,
 				fontFamily: FONT_FAMILIES[shape.props.font],
 				fontSize,
@@ -292,3 +300,15 @@ export function getArrowLabelDefaultPosition(editor: Editor, shape: TLArrowShape
 			exhaustiveSwitchError(info, 'type')
 	}
 }
+
+/** @internal */
+export function isOverArrowLabel(editor: Editor, shape: TLShape) {
+	if (!editor.isShapeOfType<TLArrowShape>(shape, 'arrow')) return false
+
+	const pointInShapeSpace = editor.getPointInShapeSpace(shape, editor.inputs.currentPagePoint)
+	// How should we handle multiple labels? Do shapes ever have multiple labels?
+	const labelGeometry = editor.getShapeGeometry<Group2d>(shape).children[1]
+	// Knowing what we know about arrows... if the shape has no text in its label,
+	// then the label geometry should not be there.
+	return labelGeometry && pointInPolygon(pointInShapeSpace, labelGeometry.vertices)
+}
diff --git a/node_modules/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/node_modules/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 0c39a5a..eed5164 100644
--- a/node_modules/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/node_modules/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -68,6 +68,7 @@ const generateImage = (dpr: number, currentZoom: number, darkMode: boolean) => {
 	return new Promise<Blob>((resolve, reject) => {
 		const size = TILE_PATTERN_SIZE * currentZoom * dpr
 
+		// NOTE: Maybe use editor container's ownerDocument
 		const canvasEl = document.createElement('canvas')
 		canvasEl.width = size
 		canvasEl.height = size
@@ -111,6 +112,7 @@ const generateImage = (dpr: number, currentZoom: number, darkMode: boolean) => {
 }
 
 const canvasBlob = (size: [number, number], fn: (ctx: CanvasRenderingContext2D) => void) => {
+	// NOTE: Maybe use editor container's ownerDocument
 	const canvas = document.createElement('canvas')
 	canvas.width = size[0]
 	canvas.height = size[1]
diff --git a/node_modules/tldraw/src/lib/tools/SelectTool/childStates/Idle.ts b/node_modules/tldraw/src/lib/tools/SelectTool/childStates/Idle.ts
index c1ef1a5..994ed8f 100644
--- a/node_modules/tldraw/src/lib/tools/SelectTool/childStates/Idle.ts
+++ b/node_modules/tldraw/src/lib/tools/SelectTool/childStates/Idle.ts
@@ -1,9 +1,7 @@
 import {
 	Editor,
-	Group2d,
 	StateNode,
 	TLAdjacentDirection,
-	TLArrowShape,
 	TLClickEventInfo,
 	TLGroupShape,
 	TLKeyboardEventInfo,
@@ -18,6 +16,7 @@ import {
 	pointInPolygon,
 	toRichText,
 } from '@tldraw/editor'
+import { isOverArrowLabel } from '../../../shapes/arrow/arrowLabel'
 import { getHitShapeOnCanvasPointerDown } from '../../selection-logic/getHitShapeOnCanvasPointerDown'
 import { getShouldEnterCropMode } from '../../selection-logic/getShouldEnterCropModeOnPointerDown'
 import { selectOnCanvasPointerUp } from '../../selection-logic/selectOnCanvasPointerUp'
@@ -98,12 +97,6 @@ export class Idle extends StateNode {
 			case 'shape': {
 				const { shape } = info
 
-				if (this.isOverArrowLabelTest(shape)) {
-					// We're moving the label on a shape.
-					this.parent.transition('pointing_arrow_label', info)
-					break
-				}
-
 				if (this.editor.isShapeOrAncestorLocked(shape)) {
 					this.parent.transition('pointing_canvas', info)
 					break
@@ -595,22 +588,7 @@ export class Idle extends StateNode {
 	isOverArrowLabelTest(shape: TLShape | undefined) {
 		if (!shape) return false
 
-		// todo: Extract into general hit test for arrows
-		if (this.editor.isShapeOfType<TLArrowShape>(shape, 'arrow')) {
-			const pointInShapeSpace = this.editor.getPointInShapeSpace(
-				shape,
-				this.editor.inputs.currentPagePoint
-			)
-			// How should we handle multiple labels? Do shapes ever have multiple labels?
-			const labelGeometry = this.editor.getShapeGeometry<Group2d>(shape).children[1]
-			// Knowing what we know about arrows... if the shape has no text in its label,
-			// then the label geometry should not be there.
-			if (labelGeometry && pointInPolygon(pointInShapeSpace, labelGeometry.vertices)) {
-				return true
-			}
-		}
-
-		return false
+		return isOverArrowLabel(this.editor, shape)
 	}
 
 	handleDoubleClickOnCanvas(info: TLClickEventInfo) {
diff --git a/node_modules/tldraw/src/lib/tools/SelectTool/childStates/PointingShape.ts b/node_modules/tldraw/src/lib/tools/SelectTool/childStates/PointingShape.ts
index 63fc7f6..e165550 100644
--- a/node_modules/tldraw/src/lib/tools/SelectTool/childStates/PointingShape.ts
+++ b/node_modules/tldraw/src/lib/tools/SelectTool/childStates/PointingShape.ts
@@ -1,4 +1,5 @@
 import { StateNode, TLPointerEventInfo, TLShape } from '@tldraw/editor'
+import { isOverArrowLabel } from '../../../shapes/arrow/arrowLabel'
 import { getTextLabels } from '../../../utils/shapes/shapes'
 
 export class PointingShape extends StateNode {
@@ -210,6 +211,12 @@ export class PointingShape extends StateNode {
 
 	override onPointerMove(info: TLPointerEventInfo) {
 		if (this.editor.inputs.isDragging) {
+			if (isOverArrowLabel(this.editor, this.hitShape)) {
+				// We're moving the label on a shape.
+				this.parent.transition('pointing_arrow_label', { ...info, shape: this.hitShape })
+				return
+			}
+
 			if (this.didCtrlOnEnter) {
 				this.parent.transition('brushing', info)
 			} else {
diff --git a/node_modules/tldraw/src/lib/ui/components/Toolbar/DefaultRichTextToolbar.tsx b/node_modules/tldraw/src/lib/ui/components/Toolbar/DefaultRichTextToolbar.tsx
index 075cfe2..b0615a6 100644
--- a/node_modules/tldraw/src/lib/ui/components/Toolbar/DefaultRichTextToolbar.tsx
+++ b/node_modules/tldraw/src/lib/ui/components/Toolbar/DefaultRichTextToolbar.tsx
@@ -188,6 +188,7 @@ function useIsMousingDownOnTextEditor(textEditor: TiptapEditor) {
 		touchDownEvents.forEach((eventName: string) => {
 			textEditor.view.dom.addEventListener(eventName, handlePointingDown)
 		})
+		const document = textEditor.view.dom.ownerDocument
 		touchUpEvents.forEach((eventName: string) => {
 			document.body.addEventListener(eventName, handlePointingUp)
 		})
diff --git a/node_modules/tldraw/src/lib/ui/components/Toolbar/OverflowingToolbar.tsx b/node_modules/tldraw/src/lib/ui/components/Toolbar/OverflowingToolbar.tsx
index 8a03a78..e5d1d52 100644
--- a/node_modules/tldraw/src/lib/ui/components/Toolbar/OverflowingToolbar.tsx
+++ b/node_modules/tldraw/src/lib/ui/components/Toolbar/OverflowingToolbar.tsx
@@ -102,7 +102,7 @@ export function OverflowingToolbar({ children }: OverflowingToolbarProps) {
 		rButtons.current = Array.from(mainToolsRef.current?.children ?? []).filter(
 			(el): el is HTMLElement => {
 				// only count html elements...
-				if (!(el instanceof HTMLElement)) return false
+				if (!el.instanceOf(HTMLElement)) return false
 
 				// ...that are buttons...
 				if (el.tagName.toLowerCase() !== 'button') return false
@@ -147,9 +147,9 @@ export function OverflowingToolbar({ children }: OverflowingToolbarProps) {
 			}
 		}
 
-		document.addEventListener('keydown', handleKeyDown)
+		editor.getContainer().ownerDocument.addEventListener('keydown', handleKeyDown)
 		return () => {
-			document.removeEventListener('keydown', handleKeyDown)
+			editor.getContainer().ownerDocument.removeEventListener('keydown', handleKeyDown)
 		}
 	}, [editor])
 
diff --git a/node_modules/tldraw/src/lib/ui/components/primitives/TldrawUiButtonPicker.tsx b/node_modules/tldraw/src/lib/ui/components/primitives/TldrawUiButtonPicker.tsx
index 661b78e..2e936aa 100644
--- a/node_modules/tldraw/src/lib/ui/components/primitives/TldrawUiButtonPicker.tsx
+++ b/node_modules/tldraw/src/lib/ui/components/primitives/TldrawUiButtonPicker.tsx
@@ -4,6 +4,7 @@ import {
 	StyleProp,
 	TLDefaultColorStyle,
 	TLDefaultColorTheme,
+	useContainer,
 	useEditor,
 } from '@tldraw/editor'
 import classNames from 'classnames'
@@ -43,6 +44,7 @@ export const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker<T extends
 		onHistoryMark,
 		theme,
 	} = props
+	const container = useContainer()
 	const editor = useEditor()
 	const msg = useTranslation()
 	const breakpoint = useBreakpoint()
@@ -58,7 +60,7 @@ export const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker<T extends
 	} = useMemo(() => {
 		const handlePointerUp = () => {
 			rPointing.current = false
-			window.removeEventListener('pointerup', handlePointerUp)
+			container.win.removeEventListener('pointerup', handlePointerUp)
 
 			// This is fun little micro-optimization to make sure that the focus
 			// is retained on a text label. That way, you can continue typing
@@ -90,8 +92,8 @@ export const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker<T extends
 			onValueChange(style, id as T)
 
 			rPointing.current = true
-			rPointingOriginalActiveElement.current = document.activeElement as HTMLElement
-			window.addEventListener('pointerup', handlePointerUp) // see TLD-658
+			rPointingOriginalActiveElement.current = container.ownerDocument.activeElement as HTMLElement
+			container.win.addEventListener('pointerup', handlePointerUp) // see TLD-658
 		}
 
 		const handleButtonPointerEnter = (e: React.PointerEvent<HTMLButtonElement>) => {
@@ -114,7 +116,7 @@ export const TldrawUiButtonPicker = memo(function TldrawUiButtonPicker<T extends
 			handleButtonPointerEnter,
 			handleButtonPointerUp,
 		}
-	}, [editor, breakpoint, value, onHistoryMark, onValueChange, style])
+	}, [editor, breakpoint, value, onHistoryMark, onValueChange, style, container])
 
 	return (
 		<TldrawUiToolbarToggleGroup
diff --git a/node_modules/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/node_modules/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index aef5f13..f449e57 100644
--- a/node_modules/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/node_modules/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -83,7 +83,7 @@ const INPUTS = ['input', 'select', 'textarea']
  * @internal
  */
 function areShortcutsDisabled(editor: Editor) {
-	const { activeElement } = document
+	const { activeElement } = editor.getContainer().ownerDocument
 
 	return (
 		editor.menus.hasAnyOpenMenus() ||
@@ -691,7 +691,10 @@ export function useMenuClipboardEvents() {
 			// input instead; e.g. when pasting text into a text shape's content
 			if (editor.getEditingShapeId() !== null) return
 
-			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
+			if (
+				Array.isArray(data) &&
+				data[0] instanceof editor.getContainer().win.window.ClipboardItem
+			) {
 				handlePasteFromClipboardApi({ editor, clipboardItems: data, point })
 				trackEvent('paste', { source: 'menu' })
 			} else {
@@ -761,6 +764,7 @@ export function useNativeClipboardEvents() {
 			}
 		}
 
+		const container = editor.getContainer()
 		const paste = (e: ClipboardEvent) => {
 			if (disablingMiddleClickPaste) {
 				stopEventPropagation(e)
@@ -790,7 +794,6 @@ export function useNativeClipboardEvents() {
 					handlePasteFromEventClipboardData(editor, e.clipboardData, point)
 				}
 			}
-
 			// if we can read from the clipboard API, we want to try using that first. that allows
 			// us to access most things, and doesn't strip out metadata added to tldraw's own
 			// copy-as-png features - so copied shapes come back in at the correct size.
@@ -801,7 +804,10 @@ export function useNativeClipboardEvents() {
 				const fallbackFiles = Array.from(e.clipboardData?.files || [])
 				navigator.clipboard.read().then(
 					(clipboardItems) => {
-						if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
+						if (
+							Array.isArray(clipboardItems) &&
+							clipboardItems[0] instanceof container.win.window.ClipboardItem
+						) {
 							handlePasteFromClipboardApi({ editor, clipboardItems, point, fallbackFiles })
 						}
 					},
@@ -818,16 +824,16 @@ export function useNativeClipboardEvents() {
 			trackEvent('paste', { source: 'kbd' })
 		}
 
-		document.addEventListener('copy', copy)
-		document.addEventListener('cut', cut)
-		document.addEventListener('paste', paste)
-		document.addEventListener('pointerup', pointerUpHandler)
+		container.ownerDocument.addEventListener('copy', copy)
+		container.ownerDocument.addEventListener('cut', cut)
+		container.ownerDocument.addEventListener('paste', paste)
+		container.ownerDocument.addEventListener('pointerup', pointerUpHandler)
 
 		return () => {
-			document.removeEventListener('copy', copy)
-			document.removeEventListener('cut', cut)
-			document.removeEventListener('paste', paste)
-			document.removeEventListener('pointerup', pointerUpHandler)
+			container.ownerDocument.removeEventListener('copy', copy)
+			container.ownerDocument.removeEventListener('cut', cut)
+			container.ownerDocument.removeEventListener('paste', paste)
+			container.ownerDocument.removeEventListener('pointerup', pointerUpHandler)
 		}
 	}, [editor, trackEvent, appIsFocused])
 }
diff --git a/node_modules/tldraw/src/lib/ui/hooks/useKeyboardShortcuts.ts b/node_modules/tldraw/src/lib/ui/hooks/useKeyboardShortcuts.ts
index 796a958..578b4c7 100644
--- a/node_modules/tldraw/src/lib/ui/hooks/useKeyboardShortcuts.ts
+++ b/node_modules/tldraw/src/lib/ui/hooks/useKeyboardShortcuts.ts
@@ -3,6 +3,7 @@ import {
 	TLPointerEventInfo,
 	isAccelKey,
 	preventDefault,
+	useContainer,
 	useEditor,
 	useValue,
 } from '@tldraw/editor'
@@ -23,6 +24,7 @@ const SKIP_KBDS = [
 
 /** @public */
 export function useKeyboardShortcuts() {
+	const container = useContainer()
 	const editor = useEditor()
 
 	const isReadonlyMode = useReadonly()
@@ -142,7 +144,7 @@ export function useKeyboardShortcuts() {
 		return () => {
 			disposables.forEach((d) => d())
 		}
-	}, [actions, tools, isReadonlyMode, editor, isFocused])
+	}, [actions, tools, isReadonlyMode, editor, container, isFocused])
 }
 
 export function areShortcutsDisabled(editor: Editor) {
diff --git a/node_modules/tldraw/src/lib/utils/assets/preload-font.ts b/node_modules/tldraw/src/lib/utils/assets/preload-font.ts
index 2612566..1296abe 100644
--- a/node_modules/tldraw/src/lib/utils/assets/preload-font.ts
+++ b/node_modules/tldraw/src/lib/utils/assets/preload-font.ts
@@ -12,7 +12,7 @@ export interface TLTypeFace {
 }
 
 /** @public */
-export async function preloadFont(id: string, font: TLTypeFace) {
+export async function preloadFont(id: string, font: TLTypeFace, targetDocument?: Document) {
 	const {
 		url,
 		style = 'normal',
@@ -38,7 +38,7 @@ export async function preloadFont(id: string, font: TLTypeFace) {
 
 	const fontInstance = new FontFace(id, `url(${url})`, descriptors)
 	await fontInstance.load()
-	document.fonts.add(fontInstance)
+	;(targetDocument ?? document).fonts.add(fontInstance)
 
 	// @ts-expect-error
 	fontInstance.$$_url = url
diff --git a/node_modules/tldraw/src/lib/utils/excalidraw/__snapshots__/putExcalidrawContent.test.tsx.snap b/node_modules/tldraw/src/lib/utils/excalidraw/__snapshots__/putExcalidrawContent.test.tsx.snap
index 9a6e1eb..ef308b1 100644
--- a/node_modules/tldraw/src/lib/utils/excalidraw/__snapshots__/putExcalidrawContent.test.tsx.snap
+++ b/node_modules/tldraw/src/lib/utils/excalidraw/__snapshots__/putExcalidrawContent.test.tsx.snap
@@ -149,13 +149,20 @@ exports[`putExcalidrawContent test fixtures bound-arrows.json 1`] = `
       "kind": "arc",
       "labelColor": "black",
       "labelPosition": 0.5,
+      "richText": {
+        "content": [
+          {
+            "type": "paragraph",
+          },
+        ],
+        "type": "doc",
+      },
       "scale": 1,
       "size": "m",
       "start": {
         "x": 0,
         "y": 0,
       },
-      "text": "",
     },
     "rotation": 0,
     "type": "arrow",
@@ -315,13 +322,20 @@ exports[`putExcalidrawContent test fixtures bound-elbow-arrows.json 1`] = `
       "kind": "elbow",
       "labelColor": "black",
       "labelPosition": 0.5,
+      "richText": {
+        "content": [
+          {
+            "type": "paragraph",
+          },
+        ],
+        "type": "doc",
+      },
       "scale": 1,
       "size": "m",
       "start": {
         "x": 0,
         "y": 0,
       },
-      "text": "",
     },
     "rotation": 0,
     "type": "arrow",
diff --git a/node_modules/tldraw/src/lib/utils/excalidraw/putExcalidrawContent.ts b/node_modules/tldraw/src/lib/utils/excalidraw/putExcalidrawContent.ts
index 6c72ade..933d93c 100644
--- a/node_modules/tldraw/src/lib/utils/excalidraw/putExcalidrawContent.ts
+++ b/node_modules/tldraw/src/lib/utils/excalidraw/putExcalidrawContent.ts
@@ -221,7 +221,7 @@ export async function putExcalidrawContent(
 					...base,
 					type: 'arrow',
 					props: {
-						text,
+						richText: toRichText(text),
 						kind: element.elbowed ? 'elbow' : 'arc',
 						bend: getBend(element, start, end),
 						dash: getDash(element),
diff --git a/node_modules/tldraw/src/lib/utils/export/export.ts b/node_modules/tldraw/src/lib/utils/export/export.ts
index 15c9378..97d0d22 100644
--- a/node_modules/tldraw/src/lib/utils/export/export.ts
+++ b/node_modules/tldraw/src/lib/utils/export/export.ts
@@ -74,7 +74,7 @@ const clipboardMimeTypesByFormat = {
 	jpeg: 'image/jpeg',
 	png: 'image/png',
 	webp: 'image/webp',
-	svg: 'text/plain',
+	svg: 'image/svg+xml',
 }
 
 export function exportToImagePromiseForClipboard(
diff --git a/node_modules/tldraw/src/lib/utils/tldr/__snapshots__/buildFromV1Document.test.ts.snap b/node_modules/tldraw/src/lib/utils/tldr/__snapshots__/buildFromV1Document.test.ts.snap
index 162eebe..582ef5d 100644
--- a/node_modules/tldraw/src/lib/utils/tldr/__snapshots__/buildFromV1Document.test.ts.snap
+++ b/node_modules/tldraw/src/lib/utils/tldr/__snapshots__/buildFromV1Document.test.ts.snap
@@ -112,13 +112,20 @@ exports[`buildFromV1Document test fixtures arrow-binding.tldr 1`] = `
       "kind": "arc",
       "labelColor": "red",
       "labelPosition": 0.5,
+      "richText": {
+        "content": [
+          {
+            "type": "paragraph",
+          },
+        ],
+        "type": "doc",
+      },
       "scale": 1,
       "size": "m",
       "start": {
         "x": 146.32,
         "y": 0,
       },
-      "text": "",
     },
     "rotation": 0,
     "type": "arrow",
@@ -241,13 +248,20 @@ exports[`buildFromV1Document test fixtures exact-arrow-binding.tldr 1`] = `
       "kind": "arc",
       "labelColor": "red",
       "labelPosition": 0.5,
+      "richText": {
+        "content": [
+          {
+            "type": "paragraph",
+          },
+        ],
+        "type": "doc",
+      },
       "scale": 1,
       "size": "m",
       "start": {
         "x": 293.36,
         "y": 0,
       },
-      "text": "",
     },
     "rotation": 0,
     "type": "arrow",
@@ -389,13 +403,20 @@ exports[`buildFromV1Document test fixtures incorrect-arrow-binding.tldr 1`] = `
       "kind": "arc",
       "labelColor": "red",
       "labelPosition": 0.5,
+      "richText": {
+        "content": [
+          {
+            "type": "paragraph",
+          },
+        ],
+        "type": "doc",
+      },
       "scale": 1,
       "size": "m",
       "start": {
         "x": 252.64,
         "y": 0,
       },
-      "text": "",
     },
     "rotation": 0,
     "type": "arrow",
diff --git a/node_modules/tldraw/src/lib/utils/tldr/buildFromV1Document.ts b/node_modules/tldraw/src/lib/utils/tldr/buildFromV1Document.ts
index aeeb354..e4885a1 100644
--- a/node_modules/tldraw/src/lib/utils/tldr/buildFromV1Document.ts
+++ b/node_modules/tldraw/src/lib/utils/tldr/buildFromV1Document.ts
@@ -405,7 +405,7 @@ export function buildFromV1Document(editor: Editor, _document: unknown) {
 									...inCommon,
 									type: 'arrow',
 									props: {
-										text: v1Shape.label ?? '',
+										richText: toRichText(v1Shape.label ?? ''),
 										color: getV2Color(v1Shape.style.color),
 										labelColor: getV2Color(v1Shape.style.color),
 										size: getV2Size(v1Shape.style.size),
